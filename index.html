<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>21 點（Blackjack）</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft JhengHei", "PingFang TC", "Noto Sans TC", sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #333;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #1e3c72;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .message-area {
            background: #f0f4f8;
            border-left: 4px solid #2a5298;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            min-height: 60px;
            font-size: 1.1em;
            color: #1e3c72;
        }

        .game-area {
            margin: 20px 0;
        }

        .hand-section {
            background: #fafafa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }

        .hand-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #1e3c72;
        }

        .cards {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            min-height: 80px;
        }

        .card {
            background: white;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 15px 12px;
            font-size: 1.5em;
            min-width: 60px;
            text-align: center;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card.red {
            color: #d32f2f;
        }

        .card.black {
            color: #333;
        }

        .card.hidden {
            background: linear-gradient(45deg, #1e3c72 25%, #2a5298 25%, #2a5298 50%, #1e3c72 50%, #1e3c72 75%, #2a5298 75%);
            background-size: 20px 20px;
            color: white;
            border-color: #1e3c72;
        }

        .hand-total {
            font-size: 1.2em;
            font-weight: bold;
            color: #2a5298;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        button {
            background: #2a5298;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        button:hover:not(:disabled) {
            background: #1e3c72;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        button:focus {
            outline: 3px solid #ffd700;
            outline-offset: 2px;
        }

        .result-win {
            background: #4caf50 !important;
            border-color: #2e7d32 !important;
        }

        .result-lose {
            background: #f44336 !important;
            border-color: #c62828 !important;
        }

        .result-push {
            background: #ff9800 !important;
            border-color: #ef6c00 !important;
        }

        @media (max-width: 600px) {
            .game-container {
                padding: 20px;
            }

            h1 {
                font-size: 1.5em;
            }

            .card {
                font-size: 1.2em;
                min-width: 50px;
                padding: 10px 8px;
            }

            button {
                padding: 12px 20px;
                font-size: 1em;
            }

            .controls {
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>21 點（Blackjack）</h1>
        
        <div class="message-area" role="status" aria-live="polite" id="message">
            歡迎來到 21 點遊戲！按下「開始發牌」開始遊戲。
        </div>

        <div class="game-area">
            <!-- 莊家區 -->
            <div class="hand-section">
                <div class="hand-title">莊家（Dealer）</div>
                <div class="cards" id="dealer-cards"></div>
                <div class="hand-total" id="dealer-total">點數：?</div>
            </div>

            <!-- 玩家區 -->
            <div class="hand-section">
                <div class="hand-title">玩家（Player）</div>
                <div class="cards" id="player-cards"></div>
                <div class="hand-total" id="player-total">點數：0</div>
            </div>
        </div>

        <!-- 控制按鈕 -->
        <div class="controls">
            <button id="start-btn">開始發牌</button>
            <button id="hit-btn" disabled>要牌 (Hit)</button>
            <button id="stand-btn" disabled>停牌 (Stand)</button>
            <button id="reset-btn" disabled>再玩一局</button>
        </div>
    </div>

    <script>
        // ===== 資料模型 =====
        const suits = {
            spades: '♠',
            hearts: '♥',
            diamonds: '♦',
            clubs: '♣'
        };

        const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];

        // 遊戲狀態
        let gameState = {
            phase: 'idle', // idle, player, dealer, result
            deck: [],
            playerHand: [],
            dealerHand: [],
            result: null
        };

        // ===== Deck 與抽牌函式 =====
        function createDeck() {
            const deck = [];
            for (let suit in suits) {
                for (let rank of ranks) {
                    deck.push({
                        suit: suit,
                        rank: rank,
                        display: suits[suit] + rank
                    });
                }
            }
            return deck;
        }

        // Fisher-Yates 洗牌演算法
        function shuffle(deck) {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
        }

        function drawCard(deck) {
            if (deck.length === 0) {
                setMessage('牌堆已空，重新建立牌堆。');
                deck.push(...createDeck());
                shuffle(deck);
            }
            return deck.pop();
        }

        // ===== 點數計算 =====
        function getCardValue(rank) {
            if (rank === 'A') return 11;
            if (['J', 'Q', 'K'].includes(rank)) return 10;
            return parseInt(rank);
        }

        function calculateHandTotal(hand) {
            let total = 0;
            let aces = 0;

            // 先計算總點數，A 都當 11
            for (let card of hand) {
                total += getCardValue(card.rank);
                if (card.rank === 'A') aces++;
            }

            // 若爆牌且有 A，將 A 從 11 降為 1
            while (total > 21 && aces > 0) {
                total -= 10;
                aces--;
            }

            return total;
        }

        // ===== UI 與旁白 =====
        function setMessage(text) {
            document.getElementById('message').textContent = text;
        }

        function renderHand(hand, elementId, hideFirst = false) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';

            hand.forEach((card, index) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card';
                
                if (hideFirst && index === 0) {
                    cardDiv.textContent = '?';
                    cardDiv.className = 'card hidden';
                    cardDiv.setAttribute('aria-label', '隱藏的牌');
                } else {
                    cardDiv.textContent = card.display;
                    if (card.suit === 'hearts' || card.suit === 'diamonds') {
                        cardDiv.classList.add('red');
                    } else {
                        cardDiv.classList.add('black');
                    }
                }
                
                container.appendChild(cardDiv);
            });
        }

        function render() {
            const { phase, playerHand, dealerHand } = gameState;

            // 顯示玩家手牌
            renderHand(playerHand, 'player-cards');
            const playerTotal = calculateHandTotal(playerHand);
            document.getElementById('player-total').textContent = `點數：${playerTotal}`;

            // 顯示莊家手牌（玩家回合時隱藏第一張）
            const hideDealer = (phase === 'player' || phase === 'idle');
            renderHand(dealerHand, 'dealer-cards', hideDealer);
            
            if (hideDealer && dealerHand.length > 0) {
                // 只顯示明牌的點數（使用相同的計算邏輯處理 Ace）
                const visibleCards = dealerHand.slice(1);
                const visibleTotal = calculateHandTotal(visibleCards);
                document.getElementById('dealer-total').textContent = `點數：? (明牌 ${visibleTotal})`;
            } else if (dealerHand.length > 0) {
                const dealerTotal = calculateHandTotal(dealerHand);
                document.getElementById('dealer-total').textContent = `點數：${dealerTotal}`;
            } else {
                document.getElementById('dealer-total').textContent = '點數：?';
            }

            // 更新按鈕狀態
            const startBtn = document.getElementById('start-btn');
            const hitBtn = document.getElementById('hit-btn');
            const standBtn = document.getElementById('stand-btn');
            const resetBtn = document.getElementById('reset-btn');

            startBtn.disabled = (phase !== 'idle');
            hitBtn.disabled = (phase !== 'player');
            standBtn.disabled = (phase !== 'player');
            resetBtn.disabled = (phase !== 'result');

            // 結果時改變訊息區樣式
            const messageArea = document.getElementById('message');
            messageArea.className = 'message-area';
            if (phase === 'result') {
                if (gameState.result === 'player_win') {
                    messageArea.classList.add('result-win');
                } else if (gameState.result === 'dealer_win') {
                    messageArea.classList.add('result-lose');
                } else if (gameState.result === 'push') {
                    messageArea.classList.add('result-push');
                }
            }
        }

        // ===== 遊戲流程 =====
        function startRound() {
            // 重置狀態
            gameState.deck = createDeck();
            shuffle(gameState.deck);
            gameState.playerHand = [];
            gameState.dealerHand = [];
            gameState.result = null;
            gameState.phase = 'player';

            // 發牌：玩家 2 張，莊家 2 張
            gameState.playerHand.push(drawCard(gameState.deck));
            gameState.dealerHand.push(drawCard(gameState.deck));
            gameState.playerHand.push(drawCard(gameState.deck));
            gameState.dealerHand.push(drawCard(gameState.deck));

            // 檢查是否有 Blackjack
            const playerTotal = calculateHandTotal(gameState.playerHand);
            const dealerTotal = calculateHandTotal(gameState.dealerHand);

            if (playerTotal === 21 || dealerTotal === 21) {
                // 有人拿到 Blackjack，直接結算
                gameState.phase = 'result';
                resolveResult();
            } else {
                setMessage('發牌完成，輪到你了。');
            }

            render();
        }

        function hit() {
            if (gameState.phase !== 'player') return;

            const card = drawCard(gameState.deck);
            gameState.playerHand.push(card);

            setMessage(`你抽到了 ${card.display}。`);

            const playerTotal = calculateHandTotal(gameState.playerHand);
            if (playerTotal > 21) {
                setMessage(`爆牌了！（${playerTotal} 點）你輸了！`);
                gameState.phase = 'result';
                gameState.result = 'dealer_win';
            }

            render();
        }

        function stand() {
            if (gameState.phase !== 'player') return;

            setMessage('你選擇停牌，輪到莊家。');
            gameState.phase = 'dealer';

            // 延遲執行莊家回合，讓玩家看到訊息
            setTimeout(() => {
                dealerPlay();
            }, 800);
        }

        function dealerPlay() {
            render(); // 先顯示莊家的完整手牌

            let dealerTotal = calculateHandTotal(gameState.dealerHand);
            
            // 使用迭代方式而非遞迴，避免潛在的堆疊溢位
            function drawNextCard() {
                if (dealerTotal >= 17) {
                    // 莊家停止抽牌，進入結算
                    setTimeout(() => {
                        resolveResult();
                    }, 800);
                    return;
                }
                
                // 莊家需要抽牌
                setTimeout(() => {
                    const card = drawCard(gameState.deck);
                    gameState.dealerHand.push(card);
                    setMessage(`莊家抽到了 ${card.display}。`);
                    
                    dealerTotal = calculateHandTotal(gameState.dealerHand);
                    if (dealerTotal > 21) {
                        setTimeout(() => {
                            setMessage(`莊家爆牌了！（${dealerTotal} 點）你贏了！`);
                            gameState.phase = 'result';
                            gameState.result = 'player_win';
                            render();
                        }, 800);
                    } else {
                        render();
                        drawNextCard(); // 繼續抽牌
                    }
                }, 1000);
            }
            
            drawNextCard();
        }

        function resolveResult() {
            const playerTotal = calculateHandTotal(gameState.playerHand);
            const dealerTotal = calculateHandTotal(gameState.dealerHand);

            gameState.phase = 'result';

            // 檢查 Blackjack（首兩張 21 點）
            const playerBlackjack = (gameState.playerHand.length === 2 && playerTotal === 21);
            const dealerBlackjack = (gameState.dealerHand.length === 2 && dealerTotal === 21);

            if (playerBlackjack && dealerBlackjack) {
                gameState.result = 'push';
                setMessage(`雙方都是 Blackjack！平手（Push）。`);
            } else if (playerBlackjack) {
                gameState.result = 'player_win';
                setMessage(`Blackjack！你贏了！（${playerTotal} 點 vs ${dealerTotal} 點）`);
            } else if (dealerBlackjack) {
                gameState.result = 'dealer_win';
                setMessage(`莊家 Blackjack！你輸了！（${playerTotal} 點 vs ${dealerTotal} 點）`);
            } else if (playerTotal > 21) {
                gameState.result = 'dealer_win';
                setMessage(`你爆牌了！（${playerTotal} 點）你輸了！`);
            } else if (dealerTotal > 21) {
                gameState.result = 'player_win';
                setMessage(`莊家爆牌了！（${dealerTotal} 點）你贏了！`);
            } else if (playerTotal > dealerTotal) {
                gameState.result = 'player_win';
                setMessage(`你贏了！（${playerTotal} 點 vs ${dealerTotal} 點）`);
            } else if (playerTotal < dealerTotal) {
                gameState.result = 'dealer_win';
                setMessage(`你輸了！（${playerTotal} 點 vs ${dealerTotal} 點）`);
            } else {
                gameState.result = 'push';
                setMessage(`平手（Push）！（${playerTotal} 點 vs ${dealerTotal} 點）`);
            }

            render();
        }

        function resetGame() {
            gameState.phase = 'idle';
            gameState.playerHand = [];
            gameState.dealerHand = [];
            gameState.result = null;
            setMessage('歡迎來到 21 點遊戲！按下「開始發牌」開始遊戲。');
            render();
        }

        // ===== 事件綁定 =====
        document.getElementById('start-btn').addEventListener('click', startRound);
        document.getElementById('hit-btn').addEventListener('click', hit);
        document.getElementById('stand-btn').addEventListener('click', stand);
        document.getElementById('reset-btn').addEventListener('click', resetGame);

        // 初始化
        render();
    </script>
</body>
</html>
