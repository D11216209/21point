# 軟體開發規格書（SPDC）— 單檔 Blackjack（21 點）Web App

> 目標：以**單一檔案 `index.html`**（含 HTML/CSS/JS）完成可在瀏覽器離線開啟運作的簡易 21 點遊戲。介面基本、抽牌隨機、並以**繁體中文**提供簡短旁白/提示。

---

## 1. 範圍（Scope）

### 1.1 產品範圍
- 提供玩家 vs. 莊家（Dealer）的 21 點回合制遊戲。
- 功能包含：開局發牌、要牌/停牌、莊家自動行動、判定勝負、重新開始。
- 使用標準 52 張牌（不含鬼牌），每回合使用一副牌。
- UI 需在單一頁面完成：顯示玩家/莊家手牌（文字或簡易卡片視覺）、目前點數、狀態訊息（旁白）。

### 1.2 非範圍（Out of Scope）
- 不做下注/籌碼/金額計算。
- 不做多副牌、算牌、防作弊、登入、排行榜。
- 不做 Split、Double Down、Insurance 等進階規則（可在後續擴充）。

---

## 2. 使用者故事（User Stories）

1. **作為玩家**，我想按下「開始遊戲」後自動發兩張牌給我與莊家，讓我能立即開始遊戲。
2. **作為玩家**，我想在我的回合按「要牌」抽一張牌，讓我嘗試接近 21 點。
3. **作為玩家**，我想按「停牌」結束我的回合，讓莊家自動抽牌並決定勝負。
4. **作為玩家**，我想看到目前點數與結果提示（繁中旁白），以理解遊戲狀態。
5. **作為玩家**，我想在回合結束後按「再玩一局」快速重開。

---

## 3. UI 規格（UI Spec）

> 單一頁面區塊清楚、按鈕可操作、提示文字可讀。

### 3.1 版面結構（建議）
- 標題：`21 點（Blackjack）`
- 狀態/旁白區：
  - 顯示目前階段（玩家回合/莊家回合/結算）
  - 顯示提示（例如：「你抽到了 ♥K（10 點）」）
- 莊家區（Dealer）：
  - 手牌列表（可先遮住第一張或全部顯示；本規格建議**玩家回合僅顯示莊家明牌 1 張**，其餘顯示「🂠/背面」）
  - 點數顯示（玩家回合可顯示「已知點數」或顯示 `?`；結算時顯示完整點數）
- 玩家區（Player）：
  - 手牌列表
  - 點數顯示
- 控制按鈕列：
  - `開始/發牌`（新回合開始，初始發牌）
  - `要牌 Hit`
  - `停牌 Stand`
  - `再玩一局 Reset`（或與開始合併，回合結束才啟用）

### 3.2 UI 狀態與按鈕啟用規則
- 初始：只啟用「開始/發牌」。
- 玩家回合：啟用「要牌」「停牌」，禁用「開始」。
- 回合結束：禁用「要牌」「停牌」，啟用「再玩一局」（或重新啟用「開始」）。

### 3.3 呈現格式（牌面）
- 牌面建議字串：`♠A`、`♥10`、`♦J`、`♣K`。
- 花色使用 `♠ ♥ ♦ ♣`。

---

## 4. 遊戲規則（Game Rules）

1. 牌點數：
   - A：可當 **1 或 11**（以不爆牌且點數最大為優先取值）。
   - J/Q/K：皆為 **10**。
   - 2–10：牌面數值。
2. 爆牌（Bust）：任一方點數 **> 21** 立即爆牌。
3. 勝負判定（簡化版）：
   - 玩家爆牌：玩家輸。
   - 玩家未爆牌、莊家爆牌：玩家贏。
   - 都未爆牌：比較點數大小，點數高者勝。
   - 平手：和局（Push）。
4. 莊家行為：
   - 玩家停牌後，莊家自動抽牌直到點數 **>= 17** 停止（常見規則）。
   - A 的 1/11 計算同玩家。

---

## 5. 資料模型（Data Model）

> 皆可在 `index.html` 的 `<script>` 以物件/陣列維護。

### 5.1 Card
- `suit`: `'spades' | 'hearts' | 'diamonds' | 'clubs'`
- `rank`: `'A' | '2' ... '10' | 'J' | 'Q' | 'K'`
- `display`: 例如 `♠A`（可由 suit+rank 轉換）

### 5.2 Deck
- `deck: Card[]`：目前牌堆（洗牌後）。
- `discard: Card[]`（可選）：本回合已抽出的牌（非必須）。

### 5.3 Hand
- `playerHand: Card[]`
- `dealerHand: Card[]`

### 5.4 Game State
- `phase`: `'idle' | 'player' | 'dealer' | 'result'`
- `messageLog: string[]`（可選）：旁白紀錄（最新一筆顯示最上方）。
- `result`: `'player_win' | 'dealer_win' | 'push' | null`

---

## 6. 函式/模組規劃（Functions / Modules in One File）

> 即使在單檔也建議以「區塊化函式」維護可讀性。

### 6.1 Deck 與抽牌
- `createDeck(): Card[]`
  - 產生 52 張牌。
- `shuffle(deck: Card[]): void`
  - 就地洗牌（Fisher–Yates）。
- `drawCard(deck: Card[]): Card`
  - 從牌堆頂端 `pop()` 一張；若牌堆空，丟出錯誤或自動重建（見 Edge Cases）。

### 6.2 點數計算
- `getCardValue(rank: string): number`
  - J/Q/K→10，A→11（先視為 11），其它→數字。
- `calculateHandTotal(hand: Card[]): { total: number; softAces: number }`（或簡化只回 total）
  - A 先當 11 累加，若 total > 21 則每張 A 依序從 11 降為 1（total -= 10）直到 total <= 21 或無 A 可降。

### 6.3 遊戲流程
- `startRound(): void`
  - 重置狀態、建立/洗牌、發牌、切換到玩家回合。
- `hit(): void`
  - 玩家抽牌；更新 UI；若玩家爆牌→結束回合。
- `stand(): void`
  - 進入莊家回合；莊家持續抽牌至 >=17 或爆牌；最後結算。
- `dealerPlay(): void`
  - 依規則抽牌與旁白。
- `resolveResult(): void`
  - 判定勝負與顯示結果。

### 6.4 UI 與旁白
- `render(): void`
  - 依 state 更新牌面、點數、按鈕狀態、訊息。
- `setMessage(text: string, append?: boolean): void`
  - 訊息顯示（繁中），可支援追加 log。

---

## 7. 洗牌/抽牌演算法（Algorithm for Shuffle/Draw）

### 7.1 洗牌：Fisher–Yates（建議）
- 對 `deck` 從尾到頭遍歷 i = n-1..1：
  - 取 `j = randomInt(0..i)`
  - 交換 `deck[i]` 與 `deck[j]`
- 時間複雜度：O(n)，均勻隨機。

### 7.2 抽牌
- 以 `pop()` 從陣列尾端取出一張（或 `shift()` 從頭端，兩者擇一但要一致）。
- 每抽一次：
  - 將牌加入對應手牌
  - 產生旁白：如「你抽到了 ♦7」
  - 重新計算點數並更新 UI

---

## 8. 事件流程（Event Flow）

### 8.1 初始化（頁面載入）
1. 綁定按鈕事件（開始/要牌/停牌/重玩）。
2. 設定初始 state：`phase='idle'`。
3. `render()` 呈現初始畫面。

### 8.2 開始/發牌（Start）
1. `startRound()`：
   - 建新牌堆→洗牌→清空手牌→phase=player
   - 玩家抽 2 張、莊家抽 2 張
2. 若玩家 2 張即 21（可選：視為 Blackjack）：
   - 直接進入結算（本規格**可簡化**為照一般比點模式，或直接判定玩家勝；建議：直接結算）。
3. `render()`。

### 8.3 玩家按「要牌」（Hit）
1. `hit()`：玩家抽 1 張。
2. 若玩家 total > 21：
   - phase='result'，result='dealer_win'，訊息「你爆牌了，莊家獲勝。」
3. 否則維持玩家回合。
4. `render()`。

### 8.4 玩家按「停牌」（Stand）
1. `stand()`：phase='dealer'。
2. `dealerPlay()`：
   - 莊家翻開暗牌旁白
   - while dealerTotal < 17：抽牌並旁白
3. `resolveResult()`→phase='result'。
4. `render()`。

### 8.5 再玩一局（Reset）
1. 清空手牌、訊息、結果。
2. phase 回到 idle 或直接 startRound（視 UI 文案）。

---

## 9. 錯誤/邊界情況（Error / Edge Cases）

1. **牌堆不足**：理論上單回合很難抽光，但仍需處理。
   - 策略 A：若 `deck.length === 0`，自動重建並洗牌（並記錄訊息「牌堆已重置」）。
   - 策略 B：直接阻止抽牌並顯示錯誤（較不友善）。
2. **連點按鈕**：
   - 在 phase 不符合時禁用按鈕。
   - 在處理中可短暫禁用以避免重入（尤其 dealerPlay 若用 setTimeout 做旁白動畫）。
3. **點數顯示一致性**：
   - 玩家回合：莊家只露一張牌；莊家點數顯示 `?` 或「已知：X」。
   - 結算後：顯示莊家完整手牌與總點數。
4. **A 計算**：多張 A（例如 A,A,9）應正確算 21（11+1+9）。
5. **黑傑克（Blackjack）**：首兩張 21。
   - 可選：直接判定較高優先（玩家/莊家）或仍走一般比較。
   - 本規格建議：
     - 玩家黑傑克且莊家非黑傑克 → 玩家勝
     - 雙方皆黑傑克 → Push
6. **平手 Push**：顯示「平手（Push）」並可重玩。

---

## 10. 無障礙（Accessibility）

1. 所有按鈕使用 `<button>`，具可聚焦與鍵盤操作（Enter/Space）。
2. 重要狀態訊息區加上：
   - `role="status"` 或 `aria-live="polite"` 讓螢幕閱讀器可播報旁白。
3. 色彩對比：背景與文字對比足夠；不要只用顏色區分結果（加上文字例如「勝/負/平手」）。
4. 版面在窄螢幕可換行（RWD 基本支援）。

---

## 11. 測試檢查清單（Testing Checklist）

### 11.1 功能測試
- [ ] 初始僅能按「開始/發牌」。
- [ ] 開始後玩家與莊家各 2 張牌，玩家看得到自己的 2 張。
- [ ] 玩家回合按「要牌」會增加玩家手牌並更新點數。
- [ ] 玩家爆牌（>21）立即結束並顯示「玩家輸」。
- [ ] 玩家按「停牌」後莊家會自動抽到 >=17。
- [ ] 莊家爆牌時玩家勝。
- [ ] 不爆牌時正確比較點數與平手處理。
- [ ] A 的 1/11 計算正確（多 A 情境）。
- [ ] 黑傑克（首 2 張 21）判定符合規格。

### 11.2 UI/狀態
- [ ] phase 切換時按鈕啟用/禁用正確。
- [ ] 玩家回合不應看見莊家暗牌（至少一張遮住）。
- [ ] 結算時翻開莊家所有牌並顯示總點數。

### 11.3 無障礙/可用性
- [ ] 只用鍵盤可完成一局（Tab 導覽、Enter 觸發）。
- [ ] `aria-live` 對旁白有效（訊息更新可被讀出）。

---

## 12. 驗收標準（Acceptance Criteria）

1. 倉庫內存在 `index.html`（本專案實作目標）與本規格文件 `spdc.md`。
2. 開啟 `index.html`（本機檔案或 GitHub Pages）可完成一局 21 點：開始→要牌/停牌→莊家行動→顯示結果→再玩一局。
3. 牌點數計算符合：A=1/11、JQK=10、爆牌>21。
4. 抽牌具備隨機性（使用 Fisher–Yates 洗牌）。
5. 全程提示/旁白為繁體中文，且結果（勝/負/平）清楚。
6. 不會出現明顯錯誤狀態（例如回合未開始卻能要牌、或結算後仍可要牌）。

---

## 附：建議旁白文案（可選）

- 開局：`「發牌完成，輪到你了。」`
- 要牌：`「你抽到了 {card}。」`
- 停牌：`「你選擇停牌，輪到莊家。」`
- 莊家抽牌：`「莊家抽到了 {card}。」`
- 爆牌：`「爆牌了！（{total} 點）」`
- 結果：`「你贏了！」 / 「你輸了！」 / 「平手（Push）。」`
